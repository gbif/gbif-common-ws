<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppIdentityFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GBIF Common Web service</a> &gt; <a href="index.source.html" class="el_package">org.gbif.ws.server.filter</a> &gt; <span class="el_source">AppIdentityFilter.java</span></div><h1>AppIdentityFilter.java</h1><pre class="source lang-java linenums">package org.gbif.ws.server.filter;

import org.gbif.api.model.common.AppPrincipal;
import org.gbif.api.model.common.ExtendedPrincipal;
import org.gbif.api.vocabulary.AppRole;
import org.gbif.ws.security.GbifAuthService;

import java.security.Principal;
import java.util.ArrayList;
import java.util.List;
import javax.annotation.Nullable;
import javax.validation.constraints.NotNull;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.SecurityContext;

import com.google.inject.Inject;
import com.google.inject.name.Named;
import com.sun.jersey.spi.container.ContainerRequest;
import com.sun.jersey.spi.container.ContainerRequestFilter;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * A filter that allows an application to identify itself as an application (as opposed to an application
 * impersonating a user).
 * In order to identify itself an application shall provide its appKey in the header x-gbif-user and sign the request
 * accordingly.
 * If the application can be authenticated AND its appKey is in the whitelist, the {@link Principal#getName()} will return the appKey and the
 * role {@link AppRole#APP} will be assigned to it.
 *
 * We use an appKey whitelist to control which app should be allowed to have the {@link AppRole#APP} while letting
 * the user impersonation available in {@link IdentityFilter}. If at some point multiple {@link AppRole} should be
 * supported the whitelist should simply be changed for something more structured.
 *
 * This filter must run AFTER {@link IdentityFilter} if user impersonation using appKey is required.
 * This filter will be skipped if the {@link ContainerRequest} already has a {@link Principal} attached.
 * This filter operates on {@link GbifAuthService#GBIF_SCHEME} only.
 * If the appKeyWhitelist list is not provided no apps will be authenticated by this filter.
 *
 */
public class AppIdentityFilter implements ContainerRequestFilter {

  public static final  String APPKEYS_WHITELIST = &quot;identity.appkeys.whitelist&quot;;

  //FIXME should probably have its own scheme but that would requires to change {@link GbifAuthService)
  private static final String GBIF_SCHEME_PREFIX = GbifAuthService.GBIF_SCHEME + &quot; &quot;;
<span class="fc" id="L49">  private static final Logger LOG = LoggerFactory.getLogger(AppIdentityFilter.class);</span>

  private final GbifAuthService authService;
  private final List&lt;String&gt; appKeyWhitelist;

  @Inject
<span class="fc" id="L55">  public AppIdentityFilter(@NotNull GbifAuthService authService, @Nullable @Named(APPKEYS_WHITELIST) List&lt;String&gt; appKeyWhitelist) {</span>
<span class="fc" id="L56">    this.authService = authService;</span>
    //defensive copy or creation
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">    this.appKeyWhitelist = appKeyWhitelist != null ? new ArrayList&lt;&gt;(appKeyWhitelist) : new ArrayList&lt;&gt;();</span>
<span class="fc" id="L59">  }</span>

  @Override
  public ContainerRequest filter(final ContainerRequest containerRequest) {

    // Only try if no user principal is already there
<span class="pc bpc" id="L65" title="1 of 4 branches missed.">    if (containerRequest.getSecurityContext() != null &amp;&amp; containerRequest.getUserPrincipal() != null) {</span>
<span class="fc" id="L66">      return containerRequest;</span>
    }

<span class="fc" id="L69">    String authorization = containerRequest.getHeaderValue(ContainerRequest.AUTHORIZATION);</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">    if (StringUtils.startsWith(authorization, GBIF_SCHEME_PREFIX)) {</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">      if (!authService.isValidRequest(containerRequest)) {</span>
<span class="nc" id="L72">        LOG.warn(&quot;Invalid GBIF authenticated request&quot;);</span>
<span class="nc" id="L73">        throw new WebApplicationException(Response.Status.UNAUTHORIZED);</span>
      }

<span class="fc" id="L76">      String username = containerRequest.getHeaderValue(GbifAuthService.HEADER_GBIF_USER);</span>
<span class="fc" id="L77">      String appKey = GbifAuthService.getAppKeyFromRequest(containerRequest::getHeaderValue);</span>

      //check if it's an app by ensuring the appkey used to sign the request is the one used as x-gbif-user
<span class="fc bfc" id="L80" title="All 4 branches covered.">      if (StringUtils.equals(appKey, username) &amp;&amp; appKeyWhitelist.contains(appKey)) {</span>
<span class="fc" id="L81">        containerRequest.setSecurityContext(new SecurityContext() {</span>
<span class="fc" id="L82">          private final ExtendedPrincipal principal = new AppPrincipal(appKey, AppRole.APP.name());</span>

          @Override
          public Principal getUserPrincipal() {
<span class="fc" id="L86">            return principal;</span>
          }

          @Override
          public boolean isUserInRole(String s) {
<span class="nc" id="L91">            return principal.hasRole(s);</span>
          }

          @Override
          public boolean isSecure() {
<span class="nc" id="L96">            return containerRequest.isSecure();</span>
          }

          @Override
          public String getAuthenticationScheme() {
<span class="nc" id="L101">            return GbifAuthService.GBIF_SCHEME;</span>
          }
        });
      }
    }
<span class="fc" id="L106">    return containerRequest;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>
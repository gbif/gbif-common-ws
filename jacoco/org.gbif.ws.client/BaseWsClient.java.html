<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseWsClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GBIF Common Web service</a> &gt; <a href="index.source.html" class="el_package">org.gbif.ws.client</a> &gt; <span class="el_source">BaseWsClient.java</span></div><h1>BaseWsClient.java</h1><pre class="source lang-java linenums">package org.gbif.ws.client;

import org.gbif.api.model.common.paging.Pageable;
import org.gbif.ws.json.JacksonJsonContextResolver;

import java.io.IOException;
import java.util.Locale;
import javax.annotation.Nullable;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.MultivaluedMap;

import com.google.common.base.Joiner;
import com.sun.jersey.api.client.GenericType;
import com.sun.jersey.api.client.WebResource;
import org.codehaus.jackson.map.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import static org.gbif.api.model.common.paging.PagingConstants.PARAM_LIMIT;
import static org.gbif.api.model.common.paging.PagingConstants.PARAM_OFFSET;

/**
 * The base webservice client for all GBIF clients not tight to a specific entity class but containing various
 * convenience methods to deal with a web resource, paging and parameters.
 */
public abstract class BaseWsClient {

<span class="nc" id="L28">  private static final Joiner PATH_JOINER = Joiner.on(&quot;/&quot;);</span>
  // Jersey client resource used for the remote communication.
  protected final WebResource resource;
<span class="nc" id="L31">  protected final Logger log = LoggerFactory.getLogger(getClass());</span>
<span class="nc" id="L32">  private final ObjectMapper mapper = new JacksonJsonContextResolver().getContext(null);</span>

<span class="nc" id="L34">  public BaseWsClient(WebResource resource) {</span>
<span class="nc" id="L35">    this.resource = resource;</span>
<span class="nc" id="L36">    log.info(&quot;Creating new {} using webservices at {}&quot;, getClass().getSimpleName(), resource.toString());</span>
<span class="nc" id="L37">  }</span>

  protected WebResource getResource() {
<span class="nc" id="L40">    return resource;</span>
  }

  /**
   * Gets the base web resource with added paging parameters.
   *
   * @param page Which may be null
   *
   * @return The resource with appropriate paging parameters set
   */
  protected WebResource getResource(@Nullable Pageable page) {
<span class="nc" id="L51">    return applyPage(resource, page);</span>
  }

  protected WebResource applyPage(WebResource resource, @Nullable Pageable page) {
<span class="nc bnc" id="L55" title="All 2 branches missed.">    if (page == null) {</span>
<span class="nc" id="L56">      return resource;</span>
    } else {
<span class="nc" id="L58">      return resource.queryParam(PARAM_LIMIT, String.valueOf(page.getLimit()))</span>
<span class="nc" id="L59">        .queryParam(PARAM_OFFSET, String.valueOf(page.getOffset()));</span>
    }
  }

  /**
   * Gets the base web resource with added paths.
   *
   * @param path optional paths to be appended to the base resource
   *
   * @return The resource with appropriate path and parameters set.
   */
  protected WebResource getResource(String... path) {
<span class="nc" id="L71">    return getResource(null, path);</span>
  }

  /**
   * Gets the base web resource with added paths and paging parameters.
   *
   * @param page Which may be null
   * @param path optional paths to be appended to the base resource
   *
   * @return The resource with appropriate path and parameters set.
   */
  protected WebResource getResource(Pageable page, String... path) {
<span class="nc" id="L83">    return getResource(page).path(PATH_JOINER.join(path));</span>
  }

  /**
   * Gets the base web resource with added paging parameters.
   *
   * @param page   optional paging parameters
   * @param params optional additional query parameters
   * @param path   optional paths to be appended to the base resource
   *
   * @return The resource with appropriate path and parameters set.
   */
  protected WebResource getResource(@Nullable Pageable page, @Nullable MultivaluedMap&lt;String, String&gt; params,
    String... path) {
<span class="nc" id="L97">    WebResource res = getResource(page, path);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">    if (params != null) {</span>
<span class="nc" id="L99">      return res.queryParams(params);</span>
    }
<span class="nc" id="L101">    return res;</span>
  }

  @Override
  public String toString() {
<span class="nc" id="L106">    return getClass().getSimpleName() + &quot;{&quot; + resource + '}';</span>
  }

  /**
   * Executes a json type http GET request with paths added to base resource.
   * The passed generic type for the requested resource is used to convert the response into an object.
   *
   * @param gt   the generic type of the returned resource.
   * @param path optional paths to be appended to the base resource.
   *
   * @return requested resource
   */
  protected &lt;T&gt; T get(GenericType&lt;T&gt; gt, String... path) {
<span class="nc" id="L119">    return get(gt, null, null, null, path);</span>
  }

  /**
   * Executes a json type http GET request with paths added to base resource.
   * The passed generic type for the requested resource is used to convert the response into an object.
   *
   * @param gt   the generic type of the returned resource.
   * @param page paging parameters to be applied to request.
   * @param path optional paths to be appended to the base resource.
   *
   * @return requested resource
   */
  protected &lt;T&gt; T get(GenericType&lt;T&gt; gt, Pageable page, String... path) {
<span class="nc" id="L133">    return get(gt, null, null, page, path);</span>
  }

  /**
   * Executes a json type http GET request with paths added to base resource.
   * The passed generic type for the requested resource is used to convert the response into an object.
   *
   * @param gt     the generic type of the returned resource.
   * @param params extra query parameters to be added to request
   * @param path   optional paths to be appended to the base resource.
   *
   * @return requested resource
   */
  protected &lt;T&gt; T get(GenericType&lt;T&gt; gt, MultivaluedMap&lt;String, String&gt; params, String... path) {
<span class="nc" id="L147">    return get(gt, null, params, null, path);</span>
  }

  /**
   * Executes a json type http GET request with paths added to base resource.
   * The passed generic type for the requested resource is used to convert the response into an object.
   *
   * @param gt     the generic type of the returned resource.
   * @param locale identifier for a region to set http language header.
   * @param page   paging parameters to be applied to request.
   * @param params extra query parameters to be added to request
   * @param path   optional paths to be appended to the base resource.
   *
   * @return requested resource
   */
  protected &lt;T&gt; T get(GenericType&lt;T&gt; gt, @Nullable Locale locale, @Nullable MultivaluedMap&lt;String, String&gt; params,
    @Nullable Pageable page, String... path) {

<span class="nc" id="L165">    WebResource res = getResource(page, params, path);</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">    if (locale == null) {</span>
<span class="nc" id="L168">      return res.type(MediaType.APPLICATION_JSON).get(gt);</span>
    }
<span class="nc" id="L170">    return res.type(MediaType.APPLICATION_JSON).acceptLanguage(locale).get(gt);</span>
  }

  /**
   * Executes a json type http GET request to any given resource.
   * The passed generic type for the requested resource is used to convert the response into an object.
   * Note that the given web resource is used to send the http request and not the internal base resource.
   *
   * @param gt       the generic type of the returned resource.
   * @param page     paging parameters to be applied to request.
   * @param resource web resource to send request to.
   *
   * @return requested resource
   */
  protected &lt;T&gt; T get(GenericType&lt;T&gt; gt, Pageable page, WebResource resource) {
<span class="nc" id="L185">    return applyPage(resource, page).type(MediaType.APPLICATION_JSON).get(gt);</span>
  }

  /**
   * Convert the http entity into a byte array to avoid jackson creating a chunked encoding request!
   */
  protected byte[] toBytes(Object entity) {
    try {
<span class="nc" id="L193">      return mapper.writeValueAsBytes(entity);</span>
<span class="nc" id="L194">    } catch (IOException e) {</span>
<span class="nc" id="L195">      log.error(&quot;Failed to serialize http entity [{}]&quot;, entity);</span>
<span class="nc" id="L196">      throw new IllegalStateException(e);</span>
    }
  }

  /**
   * Executes an http POST passing on a json encoded entity.
   *
   * @param entity to POST
   * @param path   to POST to
   */
  protected void post(Object entity, String... path) {
<span class="nc" id="L207">    getResource(path).type(MediaType.APPLICATION_JSON).post(toBytes(entity));</span>
<span class="nc" id="L208">  }</span>

  /**
   * Executes an http POST passing on a json encoded entity.
   *
   * @param gt     the generic type of the returned resource.
   * @param entity to POST
   * @param path   to POST to
   */
  protected &lt;T&gt; T post(GenericType&lt;T&gt; gt, Object entity, String... path) {
<span class="nc" id="L218">    return getResource(path).type(MediaType.APPLICATION_JSON).post(gt, toBytes(entity));</span>
  }

  /**
   * Executes an http POST passing on a json encoded entity.
   *
   * @param cl     the class of the returned resource.
   * @param entity to POST
   * @param path   to POST to
   */
  protected &lt;T&gt; T post(Class&lt;T&gt; cl, Object entity, String... path) {
<span class="nc" id="L229">    return getResource(path).type(MediaType.APPLICATION_JSON).post(cl, toBytes(entity));</span>
  }

  /**
   * Executes an http PUT passing on a json encoded entity.
   *
   * @param entity to PUT
   * @param path   to PUT to
   */
  protected void put(Object entity, String... path) {
<span class="nc" id="L239">    getResource(path).type(MediaType.APPLICATION_JSON).put(toBytes(entity));</span>
<span class="nc" id="L240">  }</span>

  /**
   * Executes an http PUT passing on a json encoded entity.
   *
   * @param gt     the generic type of the returned resource.
   * @param entity to PUT
   * @param path   to PUT to
   */
  protected &lt;T&gt; T put(GenericType&lt;T&gt; gt, Object entity, String... path) {
<span class="nc" id="L250">    return getResource(path).type(MediaType.APPLICATION_JSON).put(gt, toBytes(entity));</span>
  }

  /**
   * Executes an http PUT passing on a json encoded entity.
   *
   * @param cl     the class of the returned resource.
   * @param entity to PUT
   * @param path   to PUT to
   */
  protected &lt;T&gt; T put(Class&lt;T&gt; cl, Object entity, String... path) {
<span class="nc" id="L261">    return getResource(path).type(MediaType.APPLICATION_JSON).put(cl, toBytes(entity));</span>
  }

  /**
   * Executes an http DELETE.
   *
   * @param path to DELETE to
   */
  protected void delete(String... path) {
<span class="nc" id="L270">    getResource(path).type(MediaType.APPLICATION_JSON).delete();</span>
<span class="nc" id="L271">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>
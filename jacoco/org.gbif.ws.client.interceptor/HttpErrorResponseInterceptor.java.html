<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpErrorResponseInterceptor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GBIF Common Web service</a> &gt; <a href="index.source.html" class="el_package">org.gbif.ws.client.interceptor</a> &gt; <span class="el_source">HttpErrorResponseInterceptor.java</span></div><h1>HttpErrorResponseInterceptor.java</h1><pre class="source lang-java linenums">package org.gbif.ws.client.interceptor;

import org.gbif.api.exception.ServiceUnavailableException;

import java.security.AccessControlException;

import javax.validation.ValidationException;

import com.sun.jersey.api.client.ClientResponse;
import com.sun.jersey.api.client.UniformInterfaceException;
import org.aopalliance.intercept.MethodInterceptor;
import org.aopalliance.intercept.MethodInvocation;

/**
 * A client method interceptor that translates http response errors into actual java exceptions.
 *
 * @see &lt;a href=&quot;http://dev.gbif.org/wiki/display/POR/Service+Exceptions&quot;&gt;GBIF Dev wiki&lt;/a&gt; for exception mappings.
 *      400 =&gt; IllegalArgumentException,
 *      401 =&gt; AccessControlException,
 *      403 =&gt; AccessControlException,
 *      404 =&gt; NULL,
 *      422 =&gt; ValidationException,
 *      500 =&gt; ServiceUnavailableException,
 *      501 =&gt; UnsupportedOperationException,
 *      All other types of unexpected responses the exception passes through the interceptor unchanged.
 */
<span class="fc" id="L27">public class HttpErrorResponseInterceptor implements MethodInterceptor {</span>

  /**
   * @return a short description of the http status followed by the entire http response body
   */
  private static String readBody(UniformInterfaceException e) {
<span class="fc" id="L33">    String status = &quot;HTTP &quot; + e.getResponse().getStatus() + &quot;: &quot;;</span>
    try {
<span class="fc" id="L35">      return status + e.getResponse().getEntity(String.class);</span>
<span class="fc" id="L36">    } catch (Exception e1) {</span>
<span class="fc" id="L37">      return status + &quot;Failed to read http body&quot;;</span>
    }
  }

  @Override
  public Object invoke(MethodInvocation invocation) throws Throwable {
<span class="fc" id="L43">    Object result = null;</span>
    // exceptions can surface as the result or be thrown - catch both in this var:
<span class="fc" id="L45">    UniformInterfaceException e = null;</span>
    try {
<span class="fc" id="L47">      result = invocation.proceed();</span>
<span class="fc" id="L48">    } catch (UniformInterfaceException e2) {</span>
<span class="fc" id="L49">      e = e2;</span>
<span class="fc" id="L50">    }</span>

<span class="pc bpc" id="L52" title="1 of 2 branches missed.">    if (result instanceof UniformInterfaceException) {</span>
<span class="nc" id="L53">      e = (UniformInterfaceException) result;</span>
    }

    // now check the UniformInterfaceException if it exists
<span class="fc bfc" id="L57" title="All 2 branches covered.">    if (e != null) {</span>
<span class="fc" id="L58">      ClientResponse response = e.getResponse();</span>
<span class="fc" id="L59">      UniformInterfaceException eX = new UniformInterfaceException(readBody(e), e.getResponse());</span>

<span class="pc bpc" id="L61" title="2 of 9 branches missed.">      switch (response.getStatus()) {</span>
        case 204:
          // no content, return null;
<span class="fc" id="L64">          return null;</span>
        case 400:
<span class="fc" id="L66">          throw new IllegalArgumentException(&quot;A bad request received.&quot;, eX);</span>
        case 401:
<span class="fc" id="L68">          throw new AccessControlException(&quot;Unauthorized request received.&quot;);</span>
        case 403:
<span class="fc" id="L70">          throw new AccessControlException(&quot;Forbidden request received.&quot;);</span>
        case 404:
<span class="fc" id="L72">          return null;</span>
        case 422:
<span class="nc" id="L74">          throw new ValidationException(eX); // TODO: consider passing fields in headers</span>
        case 500:
<span class="fc" id="L76">          throw new ServiceUnavailableException(&quot;An internal server error occurred, please try again later.&quot;, eX);</span>
        case 501:
<span class="fc" id="L78">          throw new UnsupportedOperationException(&quot;Method not implement yet.&quot;, eX);</span>
        default:
<span class="nc" id="L80">          throw eX;</span>
      }
    }

<span class="fc" id="L84">    return result;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>
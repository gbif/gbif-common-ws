<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GbifWsClientModule.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GBIF Common Web service</a> &gt; <a href="index.source.html" class="el_package">org.gbif.ws.client.guice</a> &gt; <span class="el_source">GbifWsClientModule.java</span></div><h1>GbifWsClientModule.java</h1><pre class="source lang-java linenums">package org.gbif.ws.client.guice;

import org.gbif.utils.HttpUtil;
import org.gbif.ws.client.BaseWsGetClient;
import org.gbif.ws.client.interceptor.HttpErrorResponseInterceptor;
import org.gbif.ws.client.interceptor.PublicMethodMatcher;
import org.gbif.ws.json.JacksonJsonContextResolver;

import java.util.Map;
import java.util.Properties;
import java.util.Set;

import com.google.common.collect.Maps;
import com.google.common.collect.Sets;
import com.google.inject.Inject;
import com.google.inject.PrivateModule;
import com.google.inject.Provides;
import com.google.inject.Singleton;
import com.google.inject.matcher.Matchers;
import com.google.inject.name.Names;
import com.sun.jersey.api.client.Client;
import com.sun.jersey.api.client.config.ClientConfig;
import com.sun.jersey.api.client.config.DefaultClientConfig;
import com.sun.jersey.api.json.JSONConfiguration;
import com.sun.jersey.client.apache4.ApacheHttpClient4;
import com.sun.jersey.client.apache4.ApacheHttpClient4Handler;
import org.apache.http.client.HttpClient;
import org.codehaus.jackson.jaxrs.JacksonJsonProvider;

/**
 * Base web service client module.
 * Allows to specify HTTP connection parameters: httpTimeout, maxHttpConnections and maxHttpConnectionsPerRoute.
 * The default values for those parameters are: httpTimeout = 10 seconds, maxHttpConnections = 100 and
 * maxHttpConnectionsPerRoute = 100.
 */
public abstract class GbifWsClientModule extends PrivateModule {


  /**
   * Default names/keys to create an HTTP client connection.
   * The values listed in this class are the expected key in a properties file.
   */
<span class="nc" id="L43">  public static class HttpClientConnParams {</span>

    // Used for each of i) getting a connection from the pool, establishing a connection and the
    // socket timeout
    public static final String HTTP_TIMEOUT = &quot;httpTimeout&quot;;
    public static final String MAX_HTTP_CONNECTIONS = &quot;maxHttpConnections&quot;;
    public static final String MAX_HTTP_CONNECTIONS_PER_ROUTE = &quot;maxHttpConnectionsPerRoute&quot;;
  }

  private final Properties properties;
  private final Set&lt;Package&gt; clientPackages;

  // Default values to establish a client connection
  protected static final int DEFAULT_HTTP_TIMEOUT_MSECS = 10000;
  protected static final int DEFAULT_MAX_HTTP_CONNECTIONS = 100;
  protected static final int DEFAULT_MAX_HTTP_CONNECTIONS_PER_ROUTE = 100;

<span class="fc" id="L60">  protected GbifWsClientModule(Properties properties, Package... clientPackages) {</span>
<span class="fc" id="L61">    this.properties = properties;</span>
<span class="fc" id="L62">    this.clientPackages = Sets.newHashSet(clientPackages);</span>
<span class="fc" id="L63">    this.clientPackages.add(BaseWsGetClient.class.getPackage());</span>
<span class="fc" id="L64">  }</span>

  @Override
  protected final void configure() {
<span class="fc" id="L68">    Names.bindProperties(binder(), properties);</span>

    // configure jsonMixIns
<span class="fc" id="L71">    JacksonJsonContextResolver.addMixIns(getMixIns());</span>

<span class="fc" id="L73">    configureClient();</span>

    // bind common interceptors
<span class="fc bfc" id="L76" title="All 2 branches covered.">    for (Package clientPackage : clientPackages) {</span>
      // order is important!
<span class="fc" id="L78">      bindInterceptor(Matchers.inPackage(clientPackage), new PublicMethodMatcher(), new HttpErrorResponseInterceptor());</span>
<span class="fc" id="L79">    }</span>
<span class="fc" id="L80">  }</span>

  /**
   * Implement this method to configure the clients guice module.
   * You can install modules, bind classes.
   * Dont forget to expose any classes that should be visible to the outside world!
   */
  protected abstract void configureClient();


  /**
   * Override this method to pass a map of mixIn classes into the Jackson context resolver.
   * For example, the Jackson JSON configuration may need to know about how to (de)serialize polymorphic classes.
   *
   * @return the mixIn class map. Defaults to an empty map.
   */
  protected Map&lt;Class&lt;?&gt;, Class&lt;?&gt;&gt; getMixIns() {
<span class="fc" id="L97">    return Maps.newHashMap();</span>
  }

  protected Properties getProperties() {
<span class="nc" id="L101">    return properties;</span>
  }

  @Provides
  @Singleton
  public HttpClient provideHttpClient() {
<span class="fc" id="L107">    int httpTimeout = DEFAULT_HTTP_TIMEOUT_MSECS;</span>
<span class="fc" id="L108">    int maxHttpConnections = DEFAULT_MAX_HTTP_CONNECTIONS;</span>
<span class="fc" id="L109">    int maxHttpConnectionsPerRoute = DEFAULT_MAX_HTTP_CONNECTIONS_PER_ROUTE;</span>

<span class="fc bfc" id="L111" title="All 2 branches covered.">    if (properties.containsKey(HttpClientConnParams.HTTP_TIMEOUT)) {</span>
<span class="fc" id="L112">      httpTimeout = Integer.parseInt(properties.getProperty(HttpClientConnParams.HTTP_TIMEOUT));</span>
    }
<span class="fc bfc" id="L114" title="All 2 branches covered.">    if (properties.containsKey(HttpClientConnParams.MAX_HTTP_CONNECTIONS)) {</span>
<span class="fc" id="L115">      maxHttpConnections = Integer.parseInt(properties.getProperty(HttpClientConnParams.MAX_HTTP_CONNECTIONS));</span>
    }
<span class="fc bfc" id="L117" title="All 2 branches covered.">    if (properties.containsKey(HttpClientConnParams.MAX_HTTP_CONNECTIONS_PER_ROUTE)) {</span>
<span class="fc" id="L118">      maxHttpConnectionsPerRoute =</span>
<span class="fc" id="L119">        Integer.parseInt(properties.getProperty(HttpClientConnParams.MAX_HTTP_CONNECTIONS_PER_ROUTE));</span>
    }
<span class="fc" id="L121">    return HttpUtil.newMultithreadedClient(httpTimeout, maxHttpConnections, maxHttpConnectionsPerRoute);</span>
  }

  @Provides
  @Singleton
  @Inject
  public Client providesJerseyClient(HttpClient client) {
<span class="nc" id="L128">    return buildJerseyClient(client);</span>
  }

  public static Client buildJerseyClient(HttpClient client) {
<span class="nc" id="L132">    ApacheHttpClient4Handler hch = new ApacheHttpClient4Handler(client, null, false);</span>

<span class="nc" id="L134">    ClientConfig clientConfig = new DefaultClientConfig();</span>
<span class="nc" id="L135">    clientConfig.getClasses().add(JacksonJsonContextResolver.class);</span>
    // this line is critical! Note that this is the jersey version of this class name!
<span class="nc" id="L137">    clientConfig.getClasses().add(JacksonJsonProvider.class);</span>
<span class="nc" id="L138">    clientConfig.getFeatures().put(JSONConfiguration.FEATURE_POJO_MAPPING, Boolean.TRUE);</span>
<span class="nc" id="L139">    return new ApacheHttpClient4(hch, clientConfig);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RemoteAuthWebSecurityConfigurer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GBIF Common Web service</a> &gt; <a href="index.source.html" class="el_package">org.gbif.ws.remoteauth</a> &gt; <span class="el_source">RemoteAuthWebSecurityConfigurer.java</span></div><h1>RemoteAuthWebSecurityConfigurer.java</h1><pre class="source lang-java linenums">/*
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.gbif.ws.remoteauth;

import org.gbif.ws.remoteauth.app.GbifAppRemoteAuthenticationProvider;
import org.gbif.ws.remoteauth.app.GbifAppRequestFilter;
import org.gbif.ws.remoteauth.basic.BasicRemoteAuthenticationProvider;
import org.gbif.ws.remoteauth.jwt.JwtRemoteBasicAuthenticationProvider;
import org.gbif.ws.remoteauth.jwt.JwtRequestFilter;
import org.gbif.ws.server.filter.HttpServletRequestWrapperFilter;
import org.gbif.ws.server.filter.RequestHeaderParamUpdateFilter;

import java.util.Arrays;
import java.util.Collections;

import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.authentication.www.BasicAuthenticationFilter;
import org.springframework.security.web.csrf.CsrfFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;

/**
 * Security Adapter that disables the authentication redirect and use GBIF remote services.
 * Supports Basic and JWT authentication through JwtRemoteBasicAuthenticationProvider and
 * JwtRemoteBasicAuthenticationProvider.
 */
public class RemoteAuthWebSecurityConfigurer extends WebSecurityConfigurerAdapter {

  private final RemoteAuthClient remoteAuthClient;

  public RemoteAuthWebSecurityConfigurer(
<span class="nc" id="L49">      ApplicationContext context, RemoteAuthClient remoteAuthClient) {</span>

<span class="nc" id="L51">    setApplicationContext(context);</span>
<span class="nc" id="L52">    this.remoteAuthClient = remoteAuthClient;</span>
<span class="nc" id="L53">  }</span>

  @Override
  protected void configure(AuthenticationManagerBuilder auth) {
<span class="nc" id="L57">    auth.authenticationProvider(new BasicRemoteAuthenticationProvider(remoteAuthClient));</span>
<span class="nc" id="L58">    auth.authenticationProvider(new JwtRemoteBasicAuthenticationProvider(remoteAuthClient));</span>
<span class="nc" id="L59">    auth.authenticationProvider(new GbifAppRemoteAuthenticationProvider(remoteAuthClient));</span>
<span class="nc" id="L60">  }</span>

  @Override
  protected void configure(HttpSecurity http) throws Exception {
<span class="nc" id="L64">    http.httpBasic()</span>
<span class="nc" id="L65">        .and()</span>
<span class="nc" id="L66">        .addFilterAfter(</span>
<span class="nc" id="L67">            getApplicationContext().getBean(HttpServletRequestWrapperFilter.class),</span>
            CsrfFilter.class)
<span class="nc" id="L69">        .addFilterAfter(</span>
<span class="nc" id="L70">            getApplicationContext().getBean(RequestHeaderParamUpdateFilter.class),</span>
            HttpServletRequestWrapperFilter.class)
<span class="nc" id="L72">        .addFilterBefore(</span>
<span class="nc" id="L73">            new JwtRequestFilter(authenticationManager()), BasicAuthenticationFilter.class)</span>
<span class="nc" id="L74">        .addFilterAfter(</span>
<span class="nc" id="L75">            new GbifAppRequestFilter(authenticationManager()), BasicAuthenticationFilter.class)</span>
<span class="nc" id="L76">        .csrf()</span>
<span class="nc" id="L77">        .disable()</span>
<span class="nc" id="L78">        .cors()</span>
<span class="nc" id="L79">        .and()</span>
<span class="nc" id="L80">        .authorizeRequests()</span>
<span class="nc" id="L81">        .anyRequest()</span>
<span class="nc" id="L82">        .authenticated();</span>

<span class="nc" id="L84">    http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span>
<span class="nc" id="L85">  }</span>

  /**
   * Cors configuration, allows all methods and origins.
   */
  @Bean
  CorsConfigurationSource corsConfigurationSource() {
    // CorsFilter only applies this if the origin header is present in the request
<span class="nc" id="L93">    CorsConfiguration configuration = new CorsConfiguration();</span>
<span class="nc" id="L94">    configuration.setAllowedHeaders(Arrays.asList(&quot;authorization&quot;, &quot;content-type&quot;));</span>
<span class="nc" id="L95">    configuration.setAllowedOrigins(Collections.singletonList(&quot;*&quot;));</span>
<span class="nc" id="L96">    configuration.setAllowedMethods(</span>
<span class="nc" id="L97">        Arrays.asList(&quot;HEAD&quot;, &quot;GET&quot;, &quot;POST&quot;, &quot;DELETE&quot;, &quot;PUT&quot;, &quot;OPTIONS&quot;));</span>
<span class="nc" id="L98">    configuration.setExposedHeaders(</span>
<span class="nc" id="L99">        Arrays.asList(</span>
            &quot;Access-Control-Allow-Origin&quot;,
            &quot;Access-Control-Allow-Methods&quot;,
            &quot;Access-Control-Allow-Headers&quot;));
<span class="nc" id="L103">    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();</span>
<span class="nc" id="L104">    source.registerCorsConfiguration(&quot;/**&quot;, configuration);</span>
<span class="nc" id="L105">    return source;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>